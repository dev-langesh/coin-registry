import axios from "axios";
import Head from "next/head";
import React, { useEffect, useRef, useState } from "react";
import RegisterForm from "../components/register/RegisterForm";

export default function Home() {
  const isExecuted = useRef(false);
  const svgContainer = useRef<any>(null);
  const [auth, setAuth] = useState<boolean>(false);
  const [pass, setPass] = useState<string>("");

  async function getCode() {
    const req = await axios.get("/api/register/generate-qr-code");

    const data = req.data;

    svgContainer.current.innerHTML = data.svg;
  }

  useEffect(() => {
    if (!isExecuted.current) {
      if (auth) {
        getCode();
        setInterval(() => {
          getCode();
        }, 1000 * 60 * 60 * 12);
        isExecuted.current = true;
      }
    }
  }, [auth]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setPass(e.target.value);
  };

  const handleSubmit = (e: React.SyntheticEvent) => {
    e.preventDefault();

    if (pass === "admin@coin") {
      setAuth(true);
    }
  };

  return (
    <div className="">
      <Head>
        <title>Coin Registery</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className="w-screen flex items-center justify-center mt-20 space-x-16">
        {/* qrcode  */}
        {auth ? (
          <>
            <section className=" w-52 text-center fixed top-1/2 -translate-y-1/2 right-16 shadow-2xl z-40 bg-white flex items-center flex-col p-2">
              <h1 className="text-blue-500 font-bold ">QR code</h1>
              <div ref={svgContainer} className=" w-40 h-40"></div>
              <p className="break-words">
                If you registered before no need to enter name, dep, year
              </p>
            </section>

            <RegisterForm />
          </>
        ) : (
          <section className="p-4 shadow-lg mb-6">
            <form onSubmit={handleSubmit}>
              <input
                onChange={handleChange}
                className="border py-1 px-2"
                placeholder="Password"
                type="password"
              />
            </form>
          </section>
        )}
      </main>
    </div>
  );
}
